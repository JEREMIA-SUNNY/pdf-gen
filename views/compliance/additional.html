{% for page in data.pages %}
  {% set selected_options = [] %}
  {% if page.checkBoxes.option1 %}{% set _ = selected_options.append("option1") %}{% endif %}
  {% if page.checkBoxes.option2 %}{% set _ = selected_options.append("option2") %}{% endif %}
  {% if page.checkBoxes.option3 %}{% set _ = selected_options.append("option3") %}{% endif %}
  {% set selected_count = selected_options | length %}

  {% if selected_count > 0 %}
    <div style="page-break-after: always"></div>
    <h4 class="section-title">{{ page.name }}</h4>

    {% for section in page.sections %}
      {% if section.fields|length > 0 and section.name != "Cable Assembly Drawing Specifications" %}
        <div class="section">
          <h4 class="section-title" style="padding-top: 20px">{{ section.name }}</h4>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">Field Name</td>

                  {% if not section.hideSpecification %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">Customer Specification</td>
                  {% endif %}

                  {# Generate NKRF headers dynamically #}
                  {% if selected_count == 1 %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specification</td>
                  {% elif selected_count == 2 %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 1)</td>
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 2)</td>
                  {% elif selected_count == 3 %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 1)</td>
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 2)</td>
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 3)</td>
                  {% endif %}
                </tr>
              </thead>

             <tbody>
                  {% for field in section.fields %}
                    <tr>
                      <td class="td" style="vertical-align: middle;">{{ field.name }}</td>

                      {% if not section.hideSpecification %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.value
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% endif %}

                      {# Now render the correct number of columns for values #}
                      {% if selected_count == 1 %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field[selected_options[0]]
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% elif selected_count == 2 %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field[selected_options[0]]
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field[selected_options[1]]
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% elif selected_count == 3 %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.option1
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.option2
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.option3
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    {% endfor %}
   
  {% if page.extraCableAssemblyFields and page.extraCableAssemblyFields|length > 0 %}
  {% for option in selected_options %}
  <div style="page-break-before: always;"></div>
  <h4 class="section-title">CABLE ASSEMBLY SPECIFICATIONS ({{ option | capitalize }})</h4>
  <div class="table-container">
    <table class="cable-specs-table">
      <tbody>
        {% set full_row_fields = [
          "Compliance Serial #",
          "NKRF Part Number", 
          "Customer Part Number",
          "Strain Relief Sleeve Type & Length",
          "Marker Type & Length",
          "Marker Position",
          "Jacket & Colour"
        ] %}
        
        {% set fields = page.extraCableAssemblyFields %}
        
        {% for field_name in full_row_fields %}
          {% set field = fields | selectattr("name", "equalto", field_name) | first %}
          {% if field %}
            <tr>
              <td class="spec-field-name">{{ field.name }}</td>
              <td class="spec-field-value" colspan="3">
                {% if field.name == "Customer Part Number" %}
                  {{ field.value | default("-")
                    | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                    | replace("\n", "<br>")
                    | safe }}
                {% elif field.name == "Jacket & Colour" %}
                  {{ (field[option] if field[option] and field[option]|trim != "" else field.value|default("-"))
                    | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                    | replace("\n", "<br>")
                    | safe }}
                {% else %}
                  {{ (field[option] if field[option] and field[option]|trim != "" else field.value|default("-"))
                    | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                    | replace("\n", "<br>")
                    | safe }}
                {% endif %}
              </td>
            </tr>
          {% endif %}
        {% endfor %}
        
        {% set remaining_fields = fields | rejectattr("name", "in", full_row_fields) | list %}
        
        {% for i in range(0, remaining_fields|length, 2) %}
          <tr>
            <td class="spec-field-name">{{ remaining_fields[i].name }}</td>
            <td class="spec-field-value">
              {% if remaining_fields[i].name == "Jacket & Colour" %}
                {{ (remaining_fields[i][option] if remaining_fields[i][option] and remaining_fields[i][option]|trim != "" else remaining_fields[i].value|default("-"))
                  | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                  | replace("\n", "<br>")
                  | safe }}
              {% else %}
                {{ (remaining_fields[i][option] if remaining_fields[i][option] and remaining_fields[i][option]|trim != "" else remaining_fields[i].value|default("-"))
                  | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                  | replace("\n", "<br>")
                  | safe }}
              {% endif %}
            </td>
            
            {% if i + 1 < remaining_fields|length %}
              <td class="spec-field-name">{{ remaining_fields[i + 1].name }}</td>
              <td class="spec-field-value">
                {% if remaining_fields[i + 1].name == "Jacket & Colour" %}
                  {{ (remaining_fields[i + 1][option] if remaining_fields[i + 1][option] and remaining_fields[i + 1][option]|trim != "" else remaining_fields[i + 1].value|default("-"))
                    | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                    | replace("\n", "<br>")
                    | safe }}
                {% else %}
                  {{ (remaining_fields[i + 1][option] if remaining_fields[i + 1][option] and remaining_fields[i + 1][option]|trim != "" else remaining_fields[i + 1].value|default("-"))
                    | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                    | replace("\n", "<br>")
                    | safe }}
                {% endif %}
              </td>
            {% else %}
              <td class="spec-field-name"></td>
              <td class="spec-field-value"></td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
  {% endif %}

<style>
  .cable-specs-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
    margin-top: 10px;
  }

  .cable-specs-table td {
    border: 1px solid #000;
    padding: 4px 8px;
    vertical-align: middle;
  }

  .spec-field-name {
    width: 25%;
    font-weight: bold;
    background-color: #f5f5f5;
  }

  .spec-field-value {
    width: 25%;
    text-align: center;
  }
  .cable-specs-table tr:has(td[colspan="3"]) .spec-field-name {
    width: 25%;
  }

  .cable-specs-table tr:has(td[colspan="3"]) .spec-field-value {
    width: 75%;
  }
</style>




  {% endif %}
{% endfor %}

