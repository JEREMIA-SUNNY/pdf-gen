{% for page in data.pages %}
  {% set selected_options = [] %}
  {% if page.checkBoxes.option1 %}{% set _ = selected_options.append("option1") %}{% endif %}
  {% if page.checkBoxes.option2 %}{% set _ = selected_options.append("option2") %}{% endif %}
  {% if page.checkBoxes.option3 %}{% set _ = selected_options.append("option3") %}{% endif %}
  {% set selected_count = selected_options | length %}

  {% if selected_count > 0 %}
    <div style="page-break-after: always"></div>
    <h4 class="section-title">{{ page.name }}</h4>

    {% for section in page.sections %}
      {% if section.fields|length > 0 and section.name != "Cable Assembly Drawing Specifications" %}
        <div class="section">
          <h4 class="section-title" style="padding-top: 20px">{{ section.name }}</h4>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">Field Name</td>

                  {% if not section.hideSpecification %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">Customer Specification</td>
                  {% endif %}

                  {# Generate NKRF headers dynamically #}
                  {% if selected_count == 1 %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specification</td>
                  {% elif selected_count == 2 %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 1)</td>
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 2)</td>
                  {% elif selected_count == 3 %}
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 1)</td>
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 2)</td>
                    <td class="td td-head" style="width: calc(100% / 5); text-align: center; vertical-align: middle;">NKRF Specifications<br>(Option 3)</td>
                  {% endif %}
                </tr>
              </thead>

             <tbody>
                  {% for field in section.fields %}
                    <tr>
                      <td class="td" style="vertical-align: middle;">{{ field.name }}</td>

                      {% if not section.hideSpecification %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.value
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% endif %}

                      {# Now render the correct number of columns for values #}
                      {% if selected_count == 1 %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field[selected_options[0]]
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% elif selected_count == 2 %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field[selected_options[0]]
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field[selected_options[1]]
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% elif selected_count == 3 %}
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.option1
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.option2
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                        <td class="td" style="text-align: center; vertical-align: middle;">
                          {{ field.option3
                            | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                            | replace("\n", "<br>")
                            | safe }}
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    {% endfor %}
   
   {% if page.extraCableAssemblyFields and page.extraCableAssemblyFields|length > 0 %}
    {% for option in selected_options %}
    <!-- Technical Specification & Drawing Section -->
    <div style="page-break-before: always; margin-bottom: 30px;">
      <!-- Main Title -->
      <h3 style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 15px; color: #333;">
        TECHNICAL SPECIFICATION & DRAWING â€“ LOW LOSS RF CABLE ASSEMBLY
      </h3>
      
      <!-- Image Container -->
      <div style="text-align: center; margin: 15px 0;">
        {% if page.cableAssemblyDrawings and page.cableAssemblyDrawings[option] and page.cableAssemblyDrawings[option] != "" %}
        <img 
          src="{{ page.cableAssemblyDrawings[option] }}" 
          style="max-width: 650px; max-height: 130px; display: block; margin: 0 auto; border: 1px solid #ccc;"
          alt="Cable Assembly Drawing"
        />
        {% else %}
        <div style="width: 650px; height: 130px; padding: 20px; background-color: #f9f9f9; border: 1px dashed #ccc; display: inline-block; margin: 0 auto;">
          <p style="font-style: italic; color: #999; margin: 0; line-height: 90px; text-align: center;">
            No drawing available
          </p>
        </div>
        {% endif %}
      </div>
      
      <!-- Dimension Note - Below Image, Left Aligned -->
      <p style="text-align: left; font-style: italic; font-size: 11px; color: #666; margin-top: 10px;">
        Unless Otherwise Specified All Dimensions Are In mm
      </p>
    </div>

    <!-- Cable Assembly Specifications -->
    <div style="margin-top: 20px;">
      <h4 class="section-title">CABLE ASSEMBLY SPECIFICATIONS</h4>
      <div class="table-container">
        <table class="cable-specs-table">
          <tbody>
            {# Full-row fields at the TOP #}
            {% set top_full_row_fields = [
              "Compliance Serial #",
              "NKRF Part Number",
              "Customer Part Number"
            ] %}

            {% set fields = page.extraCableAssemblyFields %}

            {% for field_name in top_full_row_fields %}
              {% set field = fields | selectattr("name", "equalto", field_name) | first %}
              {% if field %}
                <tr>
                  <td class="spec-field-name">{{ field.name }}</td>
                  <td class="spec-field-value" colspan="3">
                    {% if field.name == "Customer Part Number" %}
                      {# Always use field.value for Customer Part Number #}
                      {% set val = field.value | default("-") %}
                    {% else %}
                      {% set val = (field[option] if field[option] and field[option]|trim != "" else field.value|default("-")) %}
                    {% endif %}
                    {{ val if val|trim != "" else "-" 
                      | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                      | replace("\n", "<br>")
                      | safe }}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}

            {# Ordered pairs (middle section) #}
            {% set ordered_pairs = [
              ["Connector End A", "Connector End B"],
              ["Cable Part Number", "Centre Conductor"],
              ["Impedance", "Outer Diameter"],
              ["Velocity of Propagation", "Shielding Effectiveness"],
              ["Jacket & Colour", "Static Bend Radius"],
              ["Assembly Length", "Length Tolerance"],
              ["Operating Frequency", "Cable Attenuation"],
              ["VSWR", "Insertion Loss"],
              ["Assembly Weight", "Assembly Operating Temperature"],
              ["Phase Match Tolerance", "Phase Match Frequency"]
            ] %}

            {% for pair in ordered_pairs %}
              <tr>
                {% for fname in pair %}
                  {% set field = fields | selectattr("name", "equalto", fname) | first %}
                  {% if field %}
                    <td class="spec-field-name">{{ field.name }}</td>
                    <td class="spec-field-value">
                      {% set val = (field[option] if field[option] and field[option]|trim != "" else field.value|default("-")) %}
                      {{ val if val|trim != "" else "-" 
                        | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                        | replace("\n", "<br>")
                        | safe }}
                    </td>
                  {% else %}
                    <td class="spec-field-name"></td>
                    <td class="spec-field-value">-</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}

            {# Bottom full-row fields #}
            {% set bottom_full_row_fields = [
              "Strain Relief Sleeve Type & Length",
              "Marker Type & Length",
              "Marker Position"
            ] %}

            {% for field_name in bottom_full_row_fields %}
              {% set field = fields | selectattr("name", "equalto", field_name) | first %}
              {% if field %}
                <tr>
                  <td class="spec-field-name">{{ field.name }}</td>
                  <td class="spec-field-value" colspan="3">
                    {% set val = (field[option] if field[option] and field[option]|trim != "" else field.value|default("-")) %}
                    {{ val if val|trim != "" else "-" 
                      | replace("Complied", "<span style='color: green; font-weight: bold;'>Complied</span>")
                      | replace("\n", "<br>")
                      | safe }}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- CUSTOM MARKER SPECIFICATIONS  -->
    {% if page.markerFields and page.markerFields|length > 0 %}
      <div style="margin-top: 30px;">
        <h4 class="section-title">CUSTOM MARKER SPECIFICATIONS</h4>
        <div class="table-container">
          <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr>
                <th style="border: 1px solid #000; padding: 8px; background-color: #f0f0f0; text-align: center; font-weight: bold; color: #000;">Customer Part Number</th>
                {% for i in range(1, 6) %}
                  <th style="border: 1px solid #000; padding: 8px; background-color: #f0f0f0; text-align: center; font-weight: bold; color: #000;">Row Header {{ i }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle;">
                  {% set partNumberField = page.extraCableAssemblyFields | selectattr("name", "equalto", "Customer Part Number") | first %}
                  {{ partNumberField.value if partNumberField else "-" }}
                </td>
                {% for i in range(0, 5) %}
                  <td style="border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle;">
                    {% if page.markerFields[i] %}
                      {{ page.markerFields[i].rowHeader | default("-") }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
    <!-- END CUSTOM MARKER SPECIFICATIONS -->

    {% endfor %}
    {% endif %}

    <style>
      .cable-specs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        margin-top: 10px;
      }

      .cable-specs-table td {
        border: 1px solid #000;
        padding: 4px 8px;
        vertical-align: middle;
      }

      .spec-field-name {
        width: 25%;
        font-weight: 600;
        background-color: #ffffff;
      }

      .spec-field-value {
        width: 25%;
        text-align: center;
      }
      .cable-specs-table tr:has(td[colspan="3"]) .spec-field-name {
        width: 25%;
      }

      .cable-specs-table tr:has(td[colspan="3"]) .spec-field-value {
        width: 75%;
      }
    </style>

  {% endif %}
{% endfor %}